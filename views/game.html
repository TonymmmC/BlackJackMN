<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack + M√©todos Num√©ricos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c4a6e, #1e293b);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 30px;
        }

        .table {
            background: #065f46;
            border-radius: 20px;
            padding: 30px;
            position: relative;
            min-height: 500px;
        }

        .hand {
            margin: 20px 0;
        }

        .cards {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }

        .card {
            width: 60px;
            height: 90px;
            background: white;
            color: black;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            font-weight: bold;
            font-size: 12px;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: scale(1.05);
        }

        .card.hearts, .card.diamonds {
            color: #dc2626;
        }

        .card.clubs, .card.spades {
            color: #1f2937;
        }

        .sidebar {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: #059669;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        button:hover:not(:disabled) {
            background: #047857;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            opacity: 0.5;
        }

        .stats {
            margin: 20px 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        .recommendation {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            transition: all 0.2s ease;
        }

        .recommendation.hit {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }

        .recommendation.stand {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
        }

        .recommendation.double {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }

        .numeric-analysis {
            margin-top: 20px;
            font-size: 12px;
        }

        .analysis-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 4px;
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }

        /* Reemplazar Chart.js con barras CSS */
        .probability-chart {
            margin-top: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .chart-label {
            width: 100px;
            font-size: 10px;
            text-align: right;
            margin-right: 10px;
        }

        .chart-bar-container {
            flex: 1;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .chart-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }

        .chart-value {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .newton-bar { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .interpolation-bar { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .integration-bar { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .monte-carlo-bar { background: linear-gradient(90deg, #a855f7, #9333ea); }

        .bet-input {
            margin: 15px 0;
            text-align: center;
        }

        input[type="number"] {
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #374151;
            width: 100%;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #059669;
        }

        .game-info {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .balance {
            font-size: 28px;
            font-weight: bold;
            color: #fbbf24;
            margin: 10px 0;
        }

        .totals {
            font-size: 18px;
            margin: 10px 0;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .animation {
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .game-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .game-status.win {
            background: rgba(34, 197, 94, 0.3);
            border: 2px solid #22c55e;
        }

        .game-status.loss {
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid #ef4444;
        }

        .game-status.draw {
            background: rgba(156, 163, 175, 0.3);
            border: 2px solid #9ca3af;
        }

        /* Indicador de rendimiento */
        .performance-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.7);
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }

        .performance-good { color: #22c55e; }
        .performance-warning { color: #f59e0b; }
        .performance-poor { color: #ef4444; }

        @media (max-width: 768px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            
            .controls {
                justify-content: center;
            }

            .card {
                width: 50px;
                height: 75px;
                font-size: 10px;
            }

            .chart-label {
                width: 80px;
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <!-- Indicador de rendimiento -->
    <div class="performance-indicator" id="performanceIndicator">
        <span id="fpsCounter">FPS: --</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>üÉè Blackjack + M√©todos Num√©ricos</h1>
            <p>An√°lisis matem√°tico en tiempo real</p>
        </div>

        <div class="game-area">
            <div class="table">
                <div class="hand" id="dealerHand">
                    <h3>üè† Dealer</h3>
                    <div class="cards" id="dealerCards"></div>
                    <div class="totals">Total: <span id="dealerTotal">-</span></div>
                </div>

                <div class="game-info">
                    <div class="balance">Balance: $<span id="balance">1000</span></div>
                    <div id="gameStatus" class="game-status">Haz clic en "Nuevo Juego" para comenzar</div>
                </div>

                <div class="hand" id="playerHand">
                    <h3>üë§ Jugador</h3>
                    <div class="cards" id="playerCards"></div>
                    <div class="totals">Total: <span id="playerTotal">-</span></div>
                </div>

                <div class="controls">
                    <button onclick="startNewGame()" id="startBtn">Nuevo Juego</button>
                    <button onclick="newHand()" id="newHandBtn" disabled>Nueva Mano</button>
                    <button onclick="hit()" id="hitBtn" disabled>Hit</button>
                    <button onclick="stand()" id="standBtn" disabled>Stand</button>
                    <button onclick="doubleDown()" id="doubleBtn" disabled>Doblar</button>
                </div>

                <div class="bet-input">
                    <label>Apuesta:</label>
                    <input type="number" id="betAmount" value="10" min="1" max="1000">
                </div>
            </div>

            <div class="sidebar">
                <div class="recommendation" id="recommendation">
                    <h4>üßÆ Recomendaci√≥n</h4>
                    <div id="recommendedAction">Haz clic en "Analizar" para obtener recomendaci√≥n</div>
                    <div id="confidence"></div>
                    <button onclick="getRecommendation()" id="analyzeBtn" disabled>Analizar</button>
                </div>

                <div class="stats">
                    <h4>üìä Estad√≠sticas</h4>
                    <div class="stat-item">
                        <span>Manos jugadas:</span>
                        <span id="handsPlayed">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Victorias:</span>
                        <span id="wins">0</span>
                    </div>
                    <div class="stat-item">
                        <span>% Victorias:</span>
                        <span id="winRate">0%</span>
                    </div>
                    <div class="stat-item">
                        <span>Ganancia total:</span>
                        <span id="totalProfit">$0</span>
                    </div>
                </div>

                <div class="numeric-analysis">
                    <h4>üî¢ An√°lisis Num√©rico</h4>
                    <div class="analysis-row">
                        <span>Newton-Raphson:</span>
                        <span id="newtonResult">-</span>
                    </div>
                    <div class="analysis-row">
                        <span>Interpolaci√≥n:</span>
                        <span id="interpolationResult">-</span>
                    </div>
                    <div class="analysis-row">
                        <span>Integraci√≥n:</span>
                        <span id="integrationResult">-</span>
                    </div>
                    <div class="analysis-row">
                        <span>Monte Carlo:</span>
                        <span id="monteCarloResult">-</span>
                    </div>
                </div>

                <!-- Gr√°fico CSS en lugar de Chart.js -->
                <div class="probability-chart">
                    <div class="chart-title">An√°lisis Comparativo</div>
                    
                    <div class="chart-bar">
                        <div class="chart-label">Newton-Raphson</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar-fill newton-bar" id="newtonBar" style="width: 0%">
                                <div class="chart-value" id="newtonValue">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-bar">
                        <div class="chart-label">Interpolaci√≥n</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar-fill interpolation-bar" id="interpolationBar" style="width: 0%">
                                <div class="chart-value" id="interpolationValue">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-bar">
                        <div class="chart-label">Integraci√≥n</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar-fill integration-bar" id="integrationBar" style="width: 0%">
                                <div class="chart-value" id="integrationValue">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-bar">
                        <div class="chart-label">Monte Carlo</div>
                        <div class="chart-bar-container">
                            <div class="chart-bar-fill monte-carlo-bar" id="monteCarloBar" style="width: 0%">
                                <div class="chart-value" id="monteCarloValue">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sistema de monitoreo de rendimiento
        class PerformanceMonitor {
            constructor() {
                this.frameCount = 0;
                this.lastTime = performance.now();
                this.fps = 0;
                this.startMonitoring();
            }

            startMonitoring() {
                const monitor = () => {
                    this.frameCount++;
                    const currentTime = performance.now();
                    
                    if (currentTime >= this.lastTime + 1000) {
                        this.fps = Math.round((this.frameCount * 1000) / (currentTime - this.lastTime));
                        this.updateFPSDisplay();
                        this.frameCount = 0;
                        this.lastTime = currentTime;
                    }
                    
                    requestAnimationFrame(monitor);
                };
                requestAnimationFrame(monitor);
            }

            updateFPSDisplay() {
                const indicator = document.getElementById('fpsCounter');
                const performanceDiv = document.getElementById('performanceIndicator');
                
                indicator.textContent = `FPS: ${this.fps}`;
                
                // Cambiar color seg√∫n rendimiento
                performanceDiv.className = 'performance-indicator ';
                if (this.fps >= 55) {
                    performanceDiv.className += 'performance-good';
                } else if (this.fps >= 30) {
                    performanceDiv.className += 'performance-warning';
                } else {
                    performanceDiv.className += 'performance-poor';
                }
            }
        }

        // Estado del juego
        let gameState = {
            gameStarted: false,
            handInProgress: false,
            playerCards: [],
            dealerCards: [],
            playerTotal: 0,
            dealerTotal: 0,
            balance: 1000,
            currentBet: 0,
            deck: [],
            stats: {
                handsPlayed: 0,
                wins: 0,
                losses: 0,
                draws: 0,
                totalProfit: 0
            }
        };

        // Funci√≥n debounce optimizada
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Clase para manejo de cartas
        class Card {
            constructor(suit, rank, value, altValue = null) {
                this.suit = suit;
                this.rank = rank;
                this.value = value;
                this.altValue = altValue;
            }

            isAce() {
                return this.rank === 'A';
            }

            getValue(useAlt = false) {
                return (useAlt && this.altValue) ? this.altValue : this.value;
            }
        }

        // Inicializar mazo
        function initializeDeck() {
            const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
            const ranks = [
                ['A', 1, 11], ['2', 2], ['3', 3], ['4', 4], ['5', 5], ['6', 6],
                ['7', 7], ['8', 8], ['9', 9], ['10', 10], ['J', 10], ['Q', 10], ['K', 10]
            ];

            gameState.deck = [];
            for (let suit of suits) {
                for (let rank of ranks) {
                    gameState.deck.push(new Card(suit, rank[0], rank[1], rank[2] || null));
                }
            }
            
            shuffleDeck();
        }

        function shuffleDeck() {
            for (let i = gameState.deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gameState.deck[i], gameState.deck[j]] = [gameState.deck[j], gameState.deck[i]];
            }
        }

        function dealCard() {
            if (gameState.deck.length === 0) {
                initializeDeck();
            }
            return gameState.deck.pop();
        }

        // Calcular total de mano considerando ases
        function calculateHandTotal(cards) {
            let total = 0;
            let aces = 0;

            for (let card of cards) {
                if (card.isAce()) {
                    aces++;
                    total += 11;
                } else {
                    total += card.getValue();
                }
            }

            while (total > 21 && aces > 0) {
                total -= 10;
                aces--;
            }

            return total;
        }

        // Funciones principales del juego
        function startNewGame() {
            initializeDeck();
            gameState.gameStarted = true;
            gameState.balance = 1000;
            gameState.stats = {
                handsPlayed: 0,
                wins: 0,
                losses: 0,
                draws: 0,
                totalProfit: 0
            };

            document.getElementById('startBtn').disabled = true;
            document.getElementById('newHandBtn').disabled = false;
            updateDisplay();
            updateGameStatus('Juego iniciado. Haz una apuesta para comenzar.', '');
        }

        function newHand() {
            const betAmount = parseInt(document.getElementById('betAmount').value);
            
            if (betAmount > gameState.balance) {
                updateGameStatus('Fondos insuficientes para esta apuesta.', 'loss');
                return;
            }

            gameState.handInProgress = true;
            gameState.currentBet = betAmount;
            gameState.balance -= betAmount;
            gameState.playerCards = [];
            gameState.dealerCards = [];

            gameState.playerCards.push(dealCard());
            gameState.dealerCards.push(dealCard());
            gameState.playerCards.push(dealCard());
            gameState.dealerCards.push(dealCard());

            gameState.playerTotal = calculateHandTotal(gameState.playerCards);
            gameState.dealerTotal = gameState.dealerCards[0].getValue();

            displayCards('playerCards', gameState.playerCards);
            displayCards('dealerCards', [gameState.dealerCards[0]]);
            
            document.getElementById('newHandBtn').disabled = true;
            document.getElementById('hitBtn').disabled = false;
            document.getElementById('standBtn').disabled = false;
            document.getElementById('doubleBtn').disabled = false;
            document.getElementById('analyzeBtn').disabled = false;

            updateDisplay();
            
            if (gameState.playerTotal === 21) {
                setTimeout(() => {
                    stand();
                }, 1000);
                updateGameStatus('¬°Blackjack! Evaluando...', 'win');
            } else {
                updateGameStatus('Tu turno. ¬øHit o Stand?', '');
                setTimeout(() => {
                    if (gameState.handInProgress && gameState.playerTotal < 21) {
                        getRecommendation();
                    }
                }, 800);
            }
        }

        function hit() {
            const newCard = dealCard();
            gameState.playerCards.push(newCard);
            gameState.playerTotal = calculateHandTotal(gameState.playerCards);

            const newCardElement = createCardElement(newCard);
            newCardElement.classList.add('animation');
            document.getElementById('playerCards').appendChild(newCardElement);

            document.getElementById('doubleBtn').disabled = true;
            updateDisplay();

            if (gameState.playerTotal > 21) {
                endHand('loss', '¬°Te pasaste! Perdiste.');
            } else if (gameState.playerTotal === 21) {
                setTimeout(() => {
                    stand();
                }, 500);
            }
        }

        function stand() {
            displayCards('dealerCards', gameState.dealerCards);
            gameState.dealerTotal = calculateHandTotal(gameState.dealerCards);

            while (gameState.dealerTotal < 17) {
                const newCard = dealCard();
                gameState.dealerCards.push(newCard);
                gameState.dealerTotal = calculateHandTotal(gameState.dealerCards);
                
                setTimeout(() => {
                    displayCards('dealerCards', gameState.dealerCards);
                    updateDisplay();
                }, 500);
            }

            setTimeout(() => {
                evaluateHand();
            }, 800);
        }

        function doubleDown() {
            if (gameState.balance < gameState.currentBet) {
                updateGameStatus('Fondos insuficientes para doblar.', 'loss');
                return;
            }

            gameState.balance -= gameState.currentBet;
            gameState.currentBet *= 2;

            hit();

            if (gameState.playerTotal <= 21) {
                setTimeout(() => {
                    stand();
                }, 1000);
            }
        }

        function evaluateHand() {
            const playerTotal = gameState.playerTotal;
            const dealerTotal = gameState.dealerTotal;
            let result = '';
            let multiplier = 0;
            let message = '';

            if (playerTotal > 21) {
                result = 'loss';
                message = '¬°Te pasaste! Perdiste.';
            } else if (dealerTotal > 21) {
                result = 'win';
                multiplier = 1;
                message = '¬°El dealer se pas√≥! Ganaste.';
            } else if (playerTotal === 21 && gameState.playerCards.length === 2 && dealerTotal !== 21) {
                result = 'blackjack';
                multiplier = 1.5;
                message = '¬°Blackjack! Ganaste con bonificaci√≥n.';
            } else if (dealerTotal === 21 && gameState.dealerCards.length === 2 && playerTotal !== 21) {
                result = 'loss';
                message = 'El dealer tiene blackjack. Perdiste.';
            } else if (playerTotal > dealerTotal) {
                result = 'win';
                multiplier = 1;
                message = '¬°Ganaste con mayor puntuaci√≥n!';
            } else if (playerTotal < dealerTotal) {
                result = 'loss';
                message = 'El dealer gan√≥ con mayor puntuaci√≥n.';
            } else {
                result = 'draw';
                gameState.balance += gameState.currentBet;
                message = 'Empate. Recuperas tu apuesta.';
            }

            if (result === 'win' || result === 'blackjack') {
                const winnings = gameState.currentBet * (1 + multiplier);
                gameState.balance += winnings;
                gameState.stats.wins++;
                gameState.stats.totalProfit += (winnings - gameState.currentBet);
            } else if (result === 'loss') {
                gameState.stats.losses++;
                gameState.stats.totalProfit -= gameState.currentBet;
            } else {
                gameState.stats.draws++;
            }

            endHand(result, message);
        }

        function endHand(result, message) {
            gameState.handInProgress = false;
            gameState.stats.handsPlayed++;
            
            document.getElementById('hitBtn').disabled = true;
            document.getElementById('standBtn').disabled = true;
            document.getElementById('doubleBtn').disabled = true;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('newHandBtn').disabled = false;

            updateGameStatus(message, result);
            updateDisplay();
            updateStats();

            gameState.currentBet = 0;
        }

        // Funci√≥n getRecommendation optimizada
        const getRecommendation = debounce(function() {
            const analysis = performNumericAnalysis();
            
            const recDiv = document.getElementById('recommendation');
            const actionDiv = document.getElementById('recommendedAction');
            const confidenceDiv = document.getElementById('confidence');

            actionDiv.innerHTML = `<strong>${analysis.recommendation.toUpperCase()}</strong>`;
            confidenceDiv.innerHTML = `Confianza: ${(analysis.confidence * 100).toFixed(1)}%`;

            recDiv.className = 'recommendation ' + analysis.recommendation;

            document.getElementById('newtonResult').textContent = analysis.newton_raphson.toFixed(4);
            document.getElementById('interpolationResult').textContent = analysis.interpolation.toFixed(4);
            document.getElementById('integrationResult').textContent = analysis.integration.toFixed(4);
            document.getElementById('monteCarloResult').textContent = analysis.monte_carlo.toFixed(4);

            updateProbabilityChart(analysis);
        }, 250);

        function performNumericAnalysis() {
            const playerTotal = gameState.playerTotal;
            const dealerVisible = gameState.dealerCards[0].getValue();

            const newtonResult = newtonRaphsonOptimalProbability(playerTotal, dealerVisible);
            const interpolationResult = newtonInterpolation(playerTotal, dealerVisible);
            const integrationResult = trapezoidalIntegration(playerTotal, dealerVisible);
            const monteCarloResult = monteCarloSimulation(playerTotal, dealerVisible, 500); // Reducido para rendimiento

            const hitProbability = (newtonResult + interpolationResult + monteCarloResult) / 3;
            const recommendation = hitProbability > 0.5 ? 'hit' : 'stand';
            const confidence = Math.abs(hitProbability - 0.5) * 2;

            return {
                recommendation,
                confidence,
                newton_raphson: newtonResult,
                interpolation: interpolationResult,
                integration: integrationResult,
                monte_carlo: monteCarloResult
            };
        }

        // Implementaci√≥n de m√©todos num√©ricos optimizados
        function newtonRaphsonOptimalProbability(playerTotal, dealerVisible) {
            if (playerTotal <= 11) return 0.9;
            if (playerTotal >= 17) return 0.1;
            
            const bustProbability = getBustProbability(playerTotal);
            const dealerBustProb = getDealerBustProbability(dealerVisible);
            
            return Math.max(0.1, Math.min(0.9, dealerBustProb - bustProbability + 0.5));
        }

        function newtonInterpolation(playerTotal, dealerVisible) {
            const knownPoints = [
                {x: 12, y: 0.31}, {x: 15, y: 0.38}, {x: 18, y: 0.67}, {x: 20, y: 0.85}
            ];
            
            for (let i = 0; i < knownPoints.length - 1; i++) {
                if (playerTotal >= knownPoints[i].x && playerTotal <= knownPoints[i + 1].x) {
                    const t = (playerTotal - knownPoints[i].x) / (knownPoints[i + 1].x - knownPoints[i].x);
                    return knownPoints[i].y + t * (knownPoints[i + 1].y - knownPoints[i].y);
                }
            }
            
            return playerTotal <= 12 ? 0.31 : 0.85;
        }

        function trapezoidalIntegration(playerTotal, dealerVisible) {
            const a = 0, b = 1;
            const n = 20; // Muy reducido para m√°ximo rendimiento
            const h = (b - a) / n;
            
            let sum = probabilityDensity(a, playerTotal) + probabilityDensity(b, playerTotal);
            
            for (let i = 1; i < n; i++) {
                const x = a + i * h;
                sum += 2 * probabilityDensity(x, playerTotal);
            }
            
            return (h / 2) * sum;
        }

        function monteCarloSimulation(playerTotal, dealerVisible, iterations) {
            let wins = 0;
            
            for (let i = 0; i < iterations; i++) {
                const simResult = simulateHand(playerTotal, dealerVisible);
                if (simResult) wins++;
            }
            
            return wins / iterations;
        }

        // Funciones auxiliares optimizadas
        function getBustProbability(playerTotal) {
            const cardsLeft = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 10, 10, 10];
            let bustCards = 0;
            
            for (let card of cardsLeft) {
                if (playerTotal + card > 21) bustCards++;
            }
            
            return bustCards / cardsLeft.length;
        }

        function getDealerBustProbability(dealerVisible) {
            const bustProbs = {
                2: 0.35, 3: 0.37, 4: 0.40, 5: 0.42, 6: 0.42,
                7: 0.26, 8: 0.24, 9: 0.23, 10: 0.21, 11: 0.11
            };
            return bustProbs[dealerVisible] || 0.25;
        }

        function probabilityDensity(x, playerTotal) {
            const optimal = playerTotal >= 17 ? 0.2 : 0.8;
            const variance = 0.1;
            return Math.exp(-Math.pow(x - optimal, 2) / (2 * variance));
        }

        function simulateHand(playerTotal, dealerVisible) {
            const newCard = Math.floor(Math.random() * 10) + 1;
            const newTotal = playerTotal + newCard;
            
            if (newTotal > 21) return false;
            
            let dealerTotal = dealerVisible + Math.floor(Math.random() * 10) + 1;
            while (dealerTotal < 17) {
                dealerTotal += Math.floor(Math.random() * 10) + 1;
            }
            
            if (dealerTotal > 21) return true;
            return newTotal > dealerTotal;
        }

        // Funciones de UI optimizadas
        function displayCards(containerId, cards) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            cards.forEach((card, index) => {
                const cardElement = createCardElement(card);
                if (index === cards.length - 1) {
                    cardElement.classList.add('animation');
                }
                container.appendChild(cardElement);
            });
        }

        function createCardElement(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = `card ${card.suit}`;
            cardDiv.innerHTML = `
                <div>${card.rank}</div>
                <div style="text-align: center;">${getSuitSymbol(card.suit)}</div>
                <div style="transform: rotate(180deg)">${card.rank}</div>
            `;
            return cardDiv;
        }

        function getSuitSymbol(suit) {
            const symbols = {
                hearts: '‚ô•',
                diamonds: '‚ô¶',
                clubs: '‚ô£',
                spades: '‚ô†'
            };
            return symbols[suit] || '?';
        }

        function updateDisplay() {
            document.getElementById('balance').textContent = gameState.balance;
            document.getElementById('playerTotal').textContent = gameState.playerTotal || '-';
            document.getElementById('dealerTotal').textContent = gameState.handInProgress ? 
                gameState.dealerCards[0].getValue() : (gameState.dealerTotal || '-');
        }

        function updateGameStatus(message, type) {
            const statusDiv = document.getElementById('gameStatus');
            statusDiv.textContent = message;
            statusDiv.className = `game-status ${type}`;
        }

        function updateStats() {
            document.getElementById('handsPlayed').textContent = gameState.stats.handsPlayed;
            document.getElementById('wins').textContent = gameState.stats.wins;
            document.getElementById('winRate').textContent = 
                gameState.stats.handsPlayed > 0 ? 
                ((gameState.stats.wins / gameState.stats.handsPlayed) * 100).toFixed(1) + '%' : '0%';
            
            const profit = gameState.stats.totalProfit;
            const profitText = profit >= 0 ? `+${profit}` : `-${Math.abs(profit)}`;
            document.getElementById('totalProfit').textContent = profitText;
        }

        // Gr√°fico CSS optimizado (reemplaza Chart.js)
        function updateProbabilityChart(data) {
            const methods = [
                { id: 'newton', value: data.newton_raphson },
                { id: 'interpolation', value: data.interpolation },
                { id: 'integration', value: data.integration },
                { id: 'monteCarlo', value: data.monte_carlo }
            ];

            methods.forEach(method => {
                const bar = document.getElementById(`${method.id}Bar`);
                const valueSpan = document.getElementById(`${method.id}Value`);
                
                if (bar && valueSpan) {
                    const percentage = Math.max(0, Math.min(100, (method.value * 100)));
                    bar.style.width = `${percentage}%`;
                    valueSpan.textContent = `${percentage.toFixed(0)}%`;
                }
            });
        }

        // Eventos de teclado ultra-optimizados
        let keydownInProgress = false;
        
        document.addEventListener('keydown', function(e) {
            if (!gameState.handInProgress || keydownInProgress || e.repeat) return;
            
            keydownInProgress = true;
            
            switch(e.key.toLowerCase()) {
                case 'h':
                    if (!document.getElementById('hitBtn').disabled) {
                        e.preventDefault();
                        hit();
                    }
                    break;
                case 's':
                    if (!document.getElementById('standBtn').disabled) {
                        e.preventDefault();
                        stand();
                    }
                    break;
                case 'd':
                    if (!document.getElementById('doubleBtn').disabled) {
                        e.preventDefault();
                        doubleDown();
                    }
                    break;
                case 'a':
                    if (!document.getElementById('analyzeBtn').disabled) {
                        e.preventDefault();
                        getRecommendation();
                    }
                    break;
                case 'n':
                    if (!document.getElementById('newHandBtn').disabled) {
                        e.preventDefault();
                        newHand();
                    }
                    break;
            }
            
            setTimeout(() => {
                keydownInProgress = false;
            }, 200);
        });

        // Inicializaci√≥n ultra-optimizada
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar monitor de rendimiento
            new PerformanceMonitor();
            
            updateGameStatus('Haz clic en "Nuevo Juego" para comenzar', '');
            
            // Inicializar gr√°fico CSS
            updateProbabilityChart({
                newton_raphson: 0,
                interpolation: 0,
                integration: 0,
                monte_carlo: 0
            });
            
            console.log('üéÆ Controles optimizados:');
            console.log('H-Hit | S-Stand | D-Doblar | A-Analizar | N-Nueva Mano');
        });

        // Sistema de limpieza de memoria
        let cleanupCounter = 0;
        const originalEndHand = endHand;
        
        endHand = function(result, message) {
            originalEndHand(result, message);
            cleanupCounter++;
            
            // Limpieza cada 5 manos
            if (cleanupCounter % 5 === 0) {
                // Limpiar referencias innecesarias
                if (window.gc && typeof window.gc === 'function') {
                    window.gc();
                }
                
                // Optimizar DOM
                const unusedElements = document.querySelectorAll('.hidden, .removed');
                unusedElements.forEach(el => el.remove());
            }
        };

        // Prevenir memory leaks
        window.addEventListener('beforeunload', function() {
            // Limpiar cualquier referencia
            gameState = null;
        });

        // Throttle para resize events
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                // Reajustar elementos si es necesario
                updateDisplay();
            }, 150);
        });

        // Sistema de auto-an√°lisis optimizado
        function autoAnalyze() {
            if (gameState.handInProgress && gameState.playerTotal < 21) {
                // Usar setTimeout en lugar de requestAnimationFrame
                setTimeout(() => {
                    getRecommendation();
                }, 600);
            }
        }

        // Funci√≥n de utilidad para debugging de rendimiento
        function logPerformanceMetrics() {
            if (performance.memory) {
                console.log('Memory Usage:', {
                    used: Math.round(performance.memory.usedJSHeapSize / 1048576) + ' MB',
                    total: Math.round(performance.memory.totalJSHeapSize / 1048576) + ' MB',
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576) + ' MB'
                });
            }
        }

        // Llamar m√©tricas cada 30 segundos
        setInterval(logPerformanceMetrics, 30000);
    </script>
</body>
</html>